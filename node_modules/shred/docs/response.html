<!DOCTYPE html>  <html> <head>   <title>response.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="examples.html">                 examples.js               </a>                                           <a class="source" href="shred.html">                 shred.js               </a>                                           <a class="source" href="content.html">                 content.js               </a>                                           <a class="source" href="headers.html">                 headers.js               </a>                                           <a class="source" href="parseUri.html">                 parseUri.js               </a>                                           <a class="source" href="request.html">                 request.js               </a>                                           <a class="source" href="response.html">                 response.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               response.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>The <code>Response object</code> encapsulates a Node.js HTTP response.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;underscore&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Content</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./content&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">HeaderMixins</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./mixins/headers&quot;</span><span class="p">)</span>
<span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Browser doesn't have zlib.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">zlib</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="nx">zlib</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;zlib&#39;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;no zlib library&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Construct a <code>Response</code> object. You should never have to do this directly. The
<code>Request</code> object handles this, getting the raw response object and passing it
in here, along with the request. The callback allows us to stream the response
and then use the callback to let the request know when it's ready.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Response</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span> 
  <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_raw</span> <span class="o">=</span> <span class="nx">raw</span><span class="p">;</span> </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The <code>._setHeaders</code> method is "private"; you can't otherwise set headers on
the response.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">_setHeaders</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">raw</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>store any cookies</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">cookieJar</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s1">&#39;set-cookie&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cookies</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s1">&#39;set-cookie&#39;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">cookieIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">cookieIndex</span> <span class="o">&lt;</span> <span class="nx">cookies</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">cookieIndex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cookies</span><span class="p">[</span><span class="nx">cookieIndex</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="sr">/domain\=/i</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">cookies</span><span class="p">[</span><span class="nx">cookieIndex</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;; domain=&#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cookies</span><span class="p">[</span><span class="nx">cookieIndex</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="sr">/path\=/i</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">cookies</span><span class="p">[</span><span class="nx">cookieIndex</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;; path=&#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">cookieJar</span><span class="p">.</span><span class="nx">setCookies</span><span class="p">(</span><span class="nx">cookies</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="nx">request</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">client</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Stream the response content entity and fire the callback when we're done.
Store the incoming data in a array of Buffers which we concatinate into one
buffer at the end.  We need to use buffers instead of strings here in order
to preserve binary data.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">chunkBuffers</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">dataLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">chunkBuffers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
    <span class="nx">dataLength</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">body</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">Buffer</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Just concatinate into a string</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">body</span> <span class="o">=</span> <span class="nx">chunkBuffers</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Initialize new buffer and add the chunks one-at-a-time.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">body</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">dataLength</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">chunkBuffers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">chunkBuffers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">copy</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
        <span class="nx">pos</span> <span class="o">+=</span> <span class="nx">chunkBuffers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">setBodyAndFinish</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">_body</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Content</span><span class="p">({</span> 
      	<span class="nx">body</span><span class="o">:</span> <span class="nx">body</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">)</span>
      <span class="p">});</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">zlib</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s2">&quot;Content-Encoding&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;gzip&#39;</span><span class="p">){</span>
      <span class="nx">zlib</span><span class="p">.</span><span class="nx">gunzip</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gunzippedBody</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">body</span> <span class="o">=</span> <span class="nx">gunzippedBody</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
        <span class="nx">setBodyAndFinish</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
      <span class="p">})</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
      <span class="nx">setBodyAndFinish</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>The <code>Response</code> object can be pretty overwhelming to view using the built-in
Node.js inspect method. We want to make it a bit more manageable. This
probably goes <a href="https://github.com/spire-io/shred/issues/2">too far in the other
direction</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Response</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">inspect</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">).</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span><span class="nx">value</span><span class="p">,</span><span class="nx">key</span><span class="p">){</span>
      <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;\t&quot;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span> <span class="k">return</span> <span class="nx">array</span><span class="p">;</span>
    <span class="p">},[]).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">summary</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;Shred Response&gt; &quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span> <span class="nx">summary</span><span class="p">,</span> <span class="s2">&quot;- Headers:&quot;</span><span class="p">,</span> <span class="nx">headers</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><code>Response</code> object properties, all of which are read-only:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperties</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
  </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <ul>
<li><strong>status</strong>. The HTTP status code for the response. </li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">status</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <ul>
<li><strong>content</strong>. The HTTP content entity, if any. Provided as a <a href="./content.html">content
object</a>, which will attempt to convert the entity based upon
the <code>content-type</code> header. The converted value is available as
<code>content.data</code>. The original raw content entity is available as
<code>content.body</code>.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_body</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">content</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <ul>
<li><strong>isRedirect</strong>. Is the response a redirect? These are responses with 3xx
status and a <code>Location</code> header.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">isRedirect</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span><span class="o">&gt;</span><span class="mi">299</span>
          <span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span><span class="o">&lt;</span><span class="mi">400</span>
          <span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <ul>
<li><strong>isError</strong>. Is the response an error? These are responses with status of
400 or greater.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">isError</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span><span class="o">&gt;</span><span class="mi">399</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Add in the <a href="./headers.js">getters for accessing the normalized headers</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">HeaderMixins</span><span class="p">.</span><span class="nx">getters</span><span class="p">(</span><span class="nx">Response</span><span class="p">);</span>
<span class="nx">HeaderMixins</span><span class="p">.</span><span class="nx">privateSetters</span><span class="p">(</span><span class="nx">Response</span><span class="p">);</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Response</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 